<!DOCTYPE html>
<html lang="en">
<head>
    <title>Calculator</title>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>

    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">-->
    <script src="assets/values/ships.js" ></script>
    <script src="assets/values/recipes.js" ></script>
    <link rel="stylesheet" href="css/bootstrap-glyphicons.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/engineer-profile.css">
    <link rel="stylesheet" href="css/calculator.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div id="header"><h1>CALCULATOR</h1><img class="image" src="assets/drawables/engineer-header.png"/></div>
    </div>
    <div id="menu-buttons" class="row">
        <div class="col-lg-12">
            <button id="page-1" class="flat-butt" onclick="switchPage(this)">Calculator</button>
            <button id="page-2" class="flat-butt" onclick="switchPage(this)">Blueprints</button>
            <button id="page-3" class="flat-butt" onclick="switchPage(this)">Inventory</button>
            <button id="page-4" class="flat-butt" onclick="switchPage(this)">Page 4</button>
            <button id="page-5" class="flat-butt" onclick="switchPage(this)">Page 5</button>
        </div>
    </div>
    <div id="div-page-1" class="row large-top-buffer">
        <div id="content-left" class="col-lg-5">
            <div class="row">
                <div class="col-lg-5 orange-header white panel"><h6>SHIP PROFILE</h6></div>
                <div class="col-lg-5 col-lg-offset-1 orange-header white panel"><h6>MODULE UPGRADE</h6></div>
            </div>
            <div class="row small-top-buffer">
                <div class="col-lg-5 no-padding">
                    <button class="btn-block flat-butt" type="button" data-toggle="modal" data-target="#selectShipModal" onclick="addStoredShips()">Select ship</button>
                </div>
                <div class="col-lg-5 col-lg-offset-1"></div>
            </div>
            <div class="row small-top-buffer">
                <div id="ship-profile" class="col-lg-5">
                </div>
                <div id="module-upgrade" class="col-lg-5 col-lg-offset-1">
                    <p>Stuff</p>
                    <p>Stuff</p>
                    <p>Stuff</p>
                    <p>Stuff</p>
                    <p>Stuff</p>
                </div>
            </div>
        </div>
        <div id="content-right" class="col-lg-7">
            <table class="table table-sm table-hover table-inverse">
                <thead>
                <tr>
                    <th>Ship Stats</th>
                    <th>Base Value</th>
                    <th>Roll Min</th>
                    <th>Roll Avg</th>
                    <th>Roll Max</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td class="no-top-border">Max Jump Range</td>
                    <td>22.57</td>
                    <td><span class="red">24.82</span></td>
                    <td>29.34</td>
                    <td><span class="blue">32.72</span></td>
                </tr>
                <tr>
                    <td class="no-top-border">Full Tank Jump Range</td>
                    <td>19.88</td>
                    <td><span class="red">21.86</span></td>
                    <td>25.84</td>
                    <td><span class="blue">28.82</span></td>
                </tr>
                <tr>
                    <td class="no-top-border">Laden Jump Range</td>
                    <td>17.26</b></td>
                    <td><span class="red">21.86</span></td>
                    <td>22.43</td>
                    <td><span class="blue">25.02</span></td>
                </tr>
                <tr>
                    <td class="no-top-border">Mass Unladen</td>
                    <td>89</td>
                    <td><span class="red">97.9</span></td>
                    <td>115.7</td>
                    <td><span class="blue">129.05</span></td>
                </tr>
                <tr>
                    <td class="no-top-border">Power Draw</td>
                    <td>19</td>
                    <td><span class="red">20.9</span></td>
                    <td>24.7</td>
                    <td><span class="blue">27.55</span></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="div-page-2" class="row large-top-buffer removed">
        <div id="content-left-2" class="col-lg-5">
            <div class="row">
                <div class="orange-header white panel"><h6>AVAILABLE BLUEPRINTS</h6></div>
                <div id="available-blueprints"></div>
            </div>
        </div>
        <div id="content-right-2" class="col-lg-7">
            <div class="orange-header white panel"><h6>CHOSEN BLUEPRINTS</h6></div>
            <div id="chosen-blueprints">
                <div id="blueprint-amounts">
                    <div class="row">
                        <div class="col-md-10">Title (Grade)</div><div class="">[-] 1 [+]</div>
                        <div class="row">
                            <div class="col-md-11 col-lg-offset-1">
                                <div class="row">
                                    <div class="component-1">Component 1 (2)</div>
                                    <div class="component-1-inventory col-lg-offset-11">2</div>
                                    <div class="component-2">Component 2 (2)</div>
                                    <div class="component-1-inventory col-lg-offset-11">2</div>
                                    <div class="component-3">Component 3 (4)</div>
                                    <div class="component-1-inventory col-lg-offset-11 red">2</div>
                                    <div class="component-4">Component 4 (2)</div>
                                    <div class="component-1-inventory col-lg-offset-11">2</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="div-page-3" class="row large-top-buffer removed">
        <div id="content-left-3" class="col-lg-5">
            <p>Page 3</p>
        </div>
        <div id="content-right-3" class="col-lg-7">
            <p>Page 3</p>
        </div>
    </div>
    <div id="div-page-4" class="row large-top-buffer removed">
        <div id="content-left-4" class="col-lg-5">
            <p>Page 4</p>
        </div>
        <div id="content-right-4" class="col-lg-7">
            <p>Page 4</p>
        </div>
    </div>
    <div id="div-page-5" class="row large-top-buffer removed">
        <div id="content-left-5" class="col-lg-5">
            <p>Page 5</p>
        </div>
        <div id="content-right-5" class="col-lg-7">
            <p>Page 5</p>
        </div>
    </div>

    <div class="modal fade" id="selectShipModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content modal-background">
                <div class="modal-header orange-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="selectShipModalLabel">Select ship</h4>
                </div>
                <div class="modal-body">
                    <div class="list-wrapper overflowed">
                        <div id="stored-ships" class="list-group">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-block flat-butt" data-toggle="modal" data-target="#addShipModal">Add new ship</button>
                    <button type="button" class="btn-block flat-butt" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addShipModal" tabindex="-1" role="dialog" aria-labelledby="addShipModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content modal-background">
                <div class="modal-header orange-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="addShipModalLabel">Add new ship</h4>
                </div>
                <div class="modal-body">
                    <div class="list-wrapper overflowed">
                        <form>
                            <fieldset class="form-group">
                                <label for="add-ship-json">Paste your <a href="http://coriolis.io">coriolis.io</a> ship profile here</label>
                                <textarea class="form-control" id="add-ship-json" rows="6"></textarea>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-block flat-butt" onclick="addAndStoreShip()">Add ship</button>
                    <button type="button" class="btn-block flat-butt" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    addStoredShips();
    //addStoredRecipes();
    addRecipes();

    function deleteShip(element) {

        if (event.stopPropagation) {
            // W3C standard variant
            event.stopPropagation()
        } else {
            // IE variant
            event.cancelBubble = true
        }

        var shipId = element.parentElement.parentElement.id;
        var storedShips = getStoredShips();
        storedShips.ships.splice(shipId, 1);
        localStorage.setItem('stored-ed-ships', JSON.stringify(storedShips));
        addStoredShips();
    }

    function addAndStoreShip() {
        var jsonStr = document.getElementById('add-ship-json').value;
        if(jsonStr != null) {
            var obj = JSON.parse(jsonStr);
            var storedShips = JSON.parse(localStorage.getItem('stored-ed-ships'));
            if(storedShips == null) {
                storedShips = JSON.parse('{"ships":[]}');
            }
            storedShips.ships.push(obj);
            localStorage.setItem('stored-ed-ships', JSON.stringify(storedShips));
            document.getElementById('add-ship-json').value = '';
            addStoredShips();
            $("#addShipModal").modal('hide');
        }
    }

    function addStoredShips() {
        var storedShips = getStoredShips();
        var storedShipsList = document.getElementById('stored-ships');
        //console.log(storedShips);
        while(storedShipsList.firstChild) {
            storedShipsList.removeChild(storedShipsList.firstChild);
        }
        if(storedShips != null) {
            for (var i = 0; i < storedShips.ships.length; i++) {

                var shipRow = document.createElement('a');
                shipRow.href = '#';
                shipRow.id = i;
                shipRow.classList = 'list-group-item list-group-item-inverted';
                shipRow.onclick = function () {
                    selectShip(this);
                };
                var shipRowContents = document.createTextNode(storedShips.ships[i].name + ' (' + storedShips.ships[i].ship + ')');
                var deleteButton = document.createElement('button');
                deleteButton.classList = 'flat-butt pull-md-right';
                deleteButton.zIndex = 500000;
                deleteButton.onclick = function () {
                    deleteShip(this);
                };
                var deleteIcon = document.createElement('span');
                deleteIcon.classList = 'glyphicon glyphicon-remove';
                deleteIcon.onclick = function () {
                    deleteShip(this);
                };
                deleteButton.appendChild(deleteIcon);
                shipRow.appendChild(deleteButton);
                shipRow.appendChild(shipRowContents);
                storedShipsList.appendChild(shipRow);
            }
        }
    }

    function addRecipes() {
        var blueprints = getBlueprints();
        //console.log(blueprints);
        //console.log(Object.keys(blueprints).length);
        var availableBlueprints = document.getElementById('available-blueprints');
        var blueprintAmounts = document.getElementById('blueprint-amounts');

        var blueprintsKeys = Object.keys(blueprints);
        blueprintsKeys.sort();
        //console.log(blueprintsKeys);

        for(var i = 0; i < blueprintsKeys.length; i++) {
            //console.log(blueprintsKeys[i]);
            if(blueprints.hasOwnProperty(blueprintsKeys[i])) {
                //console.log(blueprints[blueprintsKeys[i]]);
                var blueprintName = blueprints[blueprintsKeys[i]].name;
                var blueprintModuleName = blueprints[blueprintsKeys[i]].module;
                var counter = 1;
                for(var ii = 1; ii < Object.keys(blueprints[blueprintsKeys[i]].recipes).length+1; ii++) {
                    if(blueprints[blueprintsKeys[i]].recipes[ii] !== null) {
                        var components = Object.keys(blueprints[blueprintsKeys[i]].recipes[ii.toString()].components);

                        var pElement = document.createElement('p');
                        var textElement = document.createTextNode(blueprintModuleName);
                        var recipeRowElement = document.createElement('div');
                        recipeRowElement.classList = 'row recipeRowElement small-top-padding';
                        var recipeRowTitleElement = document.createElement('div');
                        recipeRowTitleElement.classList = 'col-md-10';
                        var recipeRowTitleText = document.createTextNode(blueprintsKeys[i]+ ' (' +counter+ ')');
                        recipeRowTitleElement.appendChild(recipeRowTitleText);
                        var recipeComponentRowElement = document.createElement('div');
                        recipeComponentRowElement.classList = 'row recipeComponentRowElement';
                        var recipeComponentElement = document.createElement('div');
                        var recipeComponentsRowElement = document.createElement('div');
                        recipeComponentsRowElement.classList = 'row recipeComponentsRowElement';
                        recipeComponentElement.classList = 'col-md-11 col-lg-offset-1';
                        pElement.id = blueprintsKeys[i]+ '-' +counter;
                        pElement.appendChild(textElement);
                        textElement = document.createTextNode(' - ' +blueprintName+ ' -');
                        pElement.appendChild(textElement);
                        textElement = document.createTextNode(' (' +counter+ ')');
                        pElement.appendChild(textElement);
                        availableBlueprints.appendChild(pElement);
                        recipeRowElement.appendChild(recipeRowTitleElement);
                        for(var component in blueprints[blueprintsKeys[i]].recipes[ii.toString()].components) {
                            if(blueprints[blueprintsKeys[i]].recipes[ii.toString()].components.hasOwnProperty(component)) {
                                //console.log(blueprints[blueprintsKeys[i]].recipes[ii.toString()].components[component]);
                                //console.log('Component: ' +component+ ' Amount: ' +blueprints[blueprintsKeys[i]].recipes[ii.toString()].components[component]);
                                //console.log('You inventory: ' +component+ ' Amount: ' +getStoredValue(component));
                                var text = component.split('-');

                                var newText = '';
                                for(var iii = 0; iii < text.length; iii++) {
                                    newText += text[iii].charAt(0).toUpperCase() + text[iii].slice(1);
                                }
                                var componentTextLeftElement = document.createElement('div');;
                                componentTextLeftElement.classList = 'component-' +ii+ ' col-lg-11';
                                var componentTextRightElement = document.createElement('div');;
                                componentTextRightElement.classList = 'component-' +ii+ '-inventory';
                                var componentTextRight = getColouredText(blueprints[blueprintsKeys[i]].recipes[ii.toString()].components[component], getStoredValue(component));
                                //var componentTextRightNode = document.createTextNode(componentTextRight);
                                componentTextRightElement.appendChild(componentTextRight);
                                var componentTextLeftNode = document.createTextNode(newText + ' (' +ii+ ')');
                                componentTextLeftElement.appendChild(componentTextLeftNode);

                                recipeComponentsRowElement.appendChild(componentTextLeftElement);
                                recipeComponentsRowElement.appendChild(componentTextRightElement);

                                //console.log(componentTextLeftElement + componentTextRightElement);
                            }
                        }
                        recipeComponentElement.appendChild(recipeComponentsRowElement);
                        recipeComponentRowElement.appendChild(recipeComponentElement);
                        recipeRowElement.appendChild(recipeComponentRowElement);
                        blueprintAmounts.appendChild(recipeRowElement);
                        counter++;


                        //console.log(components);
                        //console.log(blueprints[blueprint].recipes[i.toString()]);
                    }
                }
            }
        }
    }

    function getColouredText(requirement, inventory) {
        var spanElement = document.createElement('span');
        var spanElementText = document.createTextNode(inventory);
        spanElement.appendChild(spanElementText);
        if(inventory < requirement) {
            spanElement.classList = 'red';
        } else if(inventory > requirement) {
            spanElement.classList = 'blue';
        }
        return spanElement;
    }

    function switchPage(element) {
        for (var i = 1; i < 6; i++) {
            var page = document.getElementById('div-page-' + i);
            if (i == element.id.substr(5)) {
                page.className = page.className.replace(/(?:^|\s)removed(?!\S)/g, '');
            } else {
                page.className += " removed";
            }
        }
    }

    function selectShip(element) {
        getShipOutfitting(element.id);
        $("#selectShipModal").modal('hide');
    }

    function getStoredShips() {
        var storedShips = JSON.parse(localStorage.getItem('stored-ed-ships'));
        //console.log(storedShips);
        return storedShips;
    }

    function getBlueprints() {

        //var storedShips = JSON.parse(RECIPES);
        //console.log(storedShips);
        return BLUEPRINTS;
    }

    function getStoredShipsArray() {
        var storedShips = JSON.parse(localStorage.getItem('stored-ed-ships'));
        //console.log(storedShips);
        var ships = new Array();
        for(var i = 0; i < storedShips.ships.length; i++) {
            ships.push(storedShips.ships[i].name.replace(/ /g, '-').toLowerCase());
        }
        return ships;
    }

    function getShipOutfitting(shipId) {
        var storedShips = getStoredShips();
        var outfittingList = document.getElementById('ship-profile');
        while(outfittingList.firstChild) {
            outfittingList.removeChild(outfittingList.firstChild);
        }
        var p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.bulkheads));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode('Cargo Hatch'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.powerPlant.rating + '' + storedShips.ships[shipId].components.standard.powerPlant.class + ' Power plant'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.thrusters.rating+''+storedShips.ships[shipId].components.standard.thrusters.class+' Thrusters'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.frameShiftDrive.rating + '' + storedShips.ships[shipId].components.standard.frameShiftDrive.class + ' Frame Shift Drive'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.lifeSupport.rating + '' + storedShips.ships[shipId].components.standard.lifeSupport.class + ' Life support'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.powerDistributor.rating + '' + storedShips.ships[shipId].components.standard.powerDistributor.class + ' Power distributor'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.sensors.rating + '' + storedShips.ships[shipId].components.standard.sensors.class + ' Sensors'));
        outfittingList.appendChild(p);
        p = document.createElement('p');
        p.appendChild(document.createTextNode(storedShips.ships[shipId].components.standard.fuelTank.rating + '' + storedShips.ships[shipId].components.standard.fuelTank.class + ' Fuel tank'));
        outfittingList.appendChild(p);
        var hr = document.createElement('hr');
        outfittingList.appendChild(hr);
        for(var i = 0; i < storedShips.ships[shipId].components.hardpoints.length; i++) {
            if(storedShips.ships[shipId].components.hardpoints[i] != null) {
                p = document.createElement('p');
                p.appendChild(document.createTextNode(storedShips.ships[shipId].components.hardpoints[i].rating + '' + storedShips.ships[shipId].components.hardpoints[i].class + ' ' + storedShips.ships[shipId].components.hardpoints[i].group));
                outfittingList.appendChild(p);
            }
        }
        hr = document.createElement('hr');
        outfittingList.appendChild(hr);
        for(var i = 0; i < storedShips.ships[shipId].components.utility.length; i++) {
            if(storedShips.ships[shipId].components.utility[i] != null) {
                p = document.createElement('p');
                p.appendChild(document.createTextNode(storedShips.ships[shipId].components.utility[i].rating + '' + storedShips.ships[shipId].components.utility[i].class + ' ' + storedShips.ships[shipId].components.utility[i].group));
                outfittingList.appendChild(p);
            }
        }
        hr = document.createElement('hr');
        outfittingList.appendChild(hr);
        for(var i = 0; i < storedShips.ships[shipId].components.internal.length; i++) {
            if(storedShips.ships[shipId].components.internal[i] != null) {
                p = document.createElement('p');
                p.appendChild(document.createTextNode(storedShips.ships[shipId].components.internal[i].rating + '' + storedShips.ships[shipId].components.internal[i].class + ' ' + storedShips.ships[shipId].components.internal[i].group));
                outfittingList.appendChild(p);
            }
        }
    }

    function getStoredValue(id) {
        var value = localStorage.getItem(id);
        if(isNumeric(value)) {
            return value;
        }
        return 0;
    }

    function isNumeric(n) {
        return !isNaN(parseFloat(n)) && isFinite(n);
    }
    //$("#selectShipModal").modal('show');
    //$("#addShipModal").modal('show');
</script>
</body>
</html>